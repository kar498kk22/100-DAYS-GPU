#include <iostream>
#include <cmath>
#include <cuda_runtime.h>

__global__ void LayerNorm(const float* A, float* B, int rows, int cols) {
    int row = blockIdx.x;

    if (row < rows) {
        extern __shared__ float shared[];
        float* row_data = shared + threadIdx.x * cols;

        for (int col = threadIdx.y; col < cols; col += blockDim.y) {
            row_data[col] = A[row * cols + col];
        }
        __syncthreads();

        float mean = 0.0f;
        for (int col = 0; col < cols; col++) {
            mean += row_data[col];
        }
        mean /= cols;

        float variance = 0.0f;
        for (int col = 0; col < cols; col++) {
            float diff = row_data[col] - mean;
            variance += diff * diff;
        }
        variance /= cols;
        float stddev = sqrtf(variance + 1e-7f);

        for (int col = threadIdx.y; col < cols; col += blockDim.y) {
            B[row * cols + col] = (row_data[col] - mean) / stddev;
        }
    }
}

int main() {
    const int rows = 10, cols = 10;
    float *A, *B;

    A = (float*)malloc(rows * cols * sizeof(float));
    B = (float*)malloc(rows * cols * sizeof(float));

    for (int i = 0; i < rows * cols; i++) {
        A[i] = static_cast<float>(rand()) / RAND_MAX;
    }

    float *d_a, *d_b;
    cudaMalloc(&d_a, rows * cols * sizeof(float));
    cudaMalloc(&d_b, rows * cols * sizeof(float));
    cudaMemcpy(d_a, A, rows * cols * sizeof(float), cudaMemcpyHostToDevice);

    dim3 blockDim(1, 32);
    dim3 gridDim(rows);
    size_t shared_memory_size = blockDim.x * cols * sizeof(float);

    LayerNorm<<<gridDim, blockDim, shared_memory_size>>>(d_a, d_b, rows, cols);
    cudaDeviceSynchronize();

    cudaMemcpy(B, d_b, rows * cols * sizeof(float), cudaMemcpyDeviceToHost);

    printf("A:\n");
    for (int i = 0; i < rows; i++) {
        for (int j = 0; j < cols; j++) {
            printf("%.2f ", A[i * cols + j]);
        }
        printf("\n");
    }

    printf("\nB:\n");
 for (int i = 0; i < rows; i++) {
        for (int j = 0; j < cols; j++) {
            printf("%.2f ", B[i * cols + j]);
        }
        printf("\n");
    }

    cudaFree(d_a);
    cudaFree(d_b);
    free(A);
    free(B);

    return 0;
}
